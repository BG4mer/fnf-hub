<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FNF Hub</title>
  <link rel="stylesheet" href="style.css" />
  <meta name="theme-color" content="#071827">
  <!-- Inline tiny styles to ensure preloader covers the screen and can hide reliably even if style.css hasn't loaded -->
  <style>
    #preloader{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#000;z-index:9999;gap:12px}
    #preloader.hidden{display:none !important; visibility:hidden}
    #preloader .pre-txt{letter-spacing:1px;color:#bfc9d6;font-weight:700}
    #preloader .pre-continue{display:none;margin-top:10px;padding:8px 12px;border-radius:8px;border:none;background:#ffd54a;color:#071827;font-weight:800;cursor:pointer}
    body.prevent-scroll{overflow:hidden;height:100vh}
  </style>
</head>
<body class="prevent-scroll">
  <!-- Preloader -->
  <div id="preloader" class="preloader" role="status" aria-live="polite" aria-label="Loading FNF Hub">
    <div class="spinner" aria-hidden="true" style="width:64px;height:64px;border-radius:999px;border:6px solid rgba(255,255,255,0.06);border-top-color:#ff2d95;animation:spin 1s linear infinite"></div>
    <div class="pre-txt">FNF HUB — BOOTING</div>
    <button class="pre-continue" id="preContinue">Continue to Hub</button>
    <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
  </div>

  <!-- Background Canvas -->
  <canvas id="bg-canvas" class="bg-canvas" aria-hidden="true"></canvas>

  <!-- Topbar -->
  <header class="topbar" role="banner">
    <div class="brand" id="logoWrap" title="Click me 7x for secrets" tabindex="0">
      <img id="logo" src="assets/logo.png" alt="FNF Hub logo" width="64" height="36">
      <div class="brand-text">
        <h1>FNF Hub</h1>
        <p class="muted">All your Friday Night Funkin' web apps</p>
      </div>
    </div>

    <div class="top-actions" role="navigation" aria-label="Launcher actions">
      <div class="exp-compact" title="XP & Level">
        <div class="lvl">Lvl <span id="level">1</span></div>
        <div class="exp-bar-compact" aria-hidden="true">
          <div id="expFill" class="exp-fill" style="width:0%"></div>
        </div>
        <div class="exp-count" id="expCount">0 XP</div>
      </div>

      <button class="btn ghost" id="achBtn" aria-haspopup="dialog">Achievements</button>
      <button class="btn ghost" id="toggleGridBtn">Grid FX</button>
      <a class="btn ghost" id="githubBtn" href="https://github.com/" target="_blank" rel="noopener">GitHub</a>
    </div>
  </header>

  <!-- Main -->
  <main class="main" id="main" role="main" aria-hidden="true">
    <section class="intro">
      <div class="hero">
        <h2>Play FNF mods anywhere</h2>
        <p class="muted">Open will attempt a new tab. Try (iframe) will attempt to embed inside this page (useful for school networks). If iframe is blocked, you'll be offered the open-in-new-tab fallback.</p>
      </div>
    </section>

    <section id="controls" class="controls" aria-label="Controls">
      <input id="search" placeholder="Search apps..." aria-label="Search apps" />
      <label class="switch" title="School Mode (Try iframe first)">
        <input id="schoolToggle" type="checkbox" />
        <span class="slider"></span>
        <span class="switch-label">School Mode</span>
      </label>
      <button class="btn small" id="refreshApps">Refresh Apps</button>
    </section>

    <section id="grid" class="grid" aria-live="polite"></section>

    <section class="extras">
      <div class="card">
        <h3>Secrets & Easter Eggs</h3>
        <ul>
          <li>Click logo 7 times → Legendary Mode</li>
          <li>Type Konami (↑↑↓↓←→←→BA) → Konami Master</li>
          <li>Hover app & press <kbd>F</kbd> to favorite</li>
          <li>Open console and run <code>hub.rave()</code> for rave mode</li>
        </ul>
      </div>

      <div class="card">
        <h3>Play Safety</h3>
        <p class="muted">If GitHub or external hosting is blocked, use Try (iframe). If the app refuses to load in an iframe (X-Frame-Options), you'll see a fallback banner with Open in new tab. Works locally and on GitHub Pages.</p>
      </div>
    </section>
  </main>

  <!-- iframe preview -->
  <div id="iframePreview" class="iframe-preview hidden" role="dialog" aria-hidden="true">
    <div class="iframe-header">
      <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
      <div class="iframe-title" id="iframeTitle">Preview</div>
      <div style="flex:1"></div>
      <button id="openInTab" class="btn tiny">Open in new tab</button>
      <button id="closeIframe" class="btn tiny ghost">Close</button>
    </div>
    <iframe id="appFrame" src="about:blank" sandbox="allow-scripts allow-same-origin allow-forms" title="App preview"></iframe>
    <div id="iframeBanner" class="iframe-banner hidden">This app refused to embed (X-Frame-Options). Open in a new tab instead.</div>
  </div>

  <!-- Achievements Modal -->
  <div id="achModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="achTitle">
    <div class="modal-card">
      <header class="modal-head">
        <h2 id="achTitle">Achievements</h2>
        <div class="modal-head-right">
          <div class="exp-big">XP <span id="xpBig">0</span></div>
          <button id="closeAch" class="btn ghost">Close</button>
        </div>
      </header>

      <div id="achList" class="ach-list" role="list"></div>

      <footer class="modal-foot">
        <button id="resetBtn" class="btn danger">Reset Progress</button>
        <button id="exportBtn" class="btn">Export Save</button>
        <input type="file" id="importFile" class="hidden" accept="application/json" />
        <button id="importBtn" class="btn ghost">Import Save</button>
      </footer>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <!-- Inline preloader-control script (only HTML changed) -->
  <script>
    (function(){
      const pre = document.getElementById('preloader');
      const preContinue = document.getElementById('preContinue');
      const main = document.getElementById('main');

      let hidden = false;
      function hidePreloader(reason){
        if(hidden) return;
        hidden = true;
        try{
          pre.classList.add('hidden');
          pre.setAttribute('aria-hidden','true');
          document.body.classList.remove('prevent-scroll');
        }catch(e){}
        try{
          // reveal main for screenreaders / accessibility
          main.removeAttribute('aria-hidden');
        }catch(e){}
        console.log('Preloader hidden' + (reason ? ' — ' + reason : ''));
      }
      // expose to global so the Continue button's onclick (if used) works
      window.hidePreloader = hidePreloader;

      // hide on DOMContentLoaded (main markup parsed and most scripts with defer will run soon after)
      document.addEventListener('DOMContentLoaded', ()=>{
        // give tiny grace period for deferred script to take over (100ms), then auto-hide
        setTimeout(()=>{ hidePreloader('domcontentloaded'); }, 120);
      });

      // hide when whole window loaded (images, external resources)
      window.addEventListener('load', ()=>{ hidePreloader('window.load'); });

      // fallback: if nothing happened after 5 seconds, show Continue button and keep trying to hide
      const fallbackTimer = setTimeout(()=>{
        if(!hidden){
          const txt = pre.querySelector('.pre-txt');
          if(txt) txt.textContent = 'Taking longer than expected — click Continue';
          if(preContinue) preContinue.style.display = 'inline-block';
          // also allow auto-hide after an extra 6s in case something else finishes
          setTimeout(()=>{ if(!hidden) { hidePreloader('auto-fallback'); } }, 6000);
        }
      }, 5000);

      // Continue button handler
      if(preContinue){
        preContinue.addEventListener('click', ()=>{ hidePreloader('manual-continue'); });
      }

      // If some other script wants to signal readiness, it can dispatch `window.dispatchEvent(new Event('fnfhub-ready'))`
      window.addEventListener('fnfhub-ready', ()=>{ hidePreloader('fnfhub-ready'); });

      // Also listen for "script.js loaded" if the script is included with id="mainScript" — helpful if you keep that id on the script tag.
      // (we don't require it; this is just a no-op if not present)
      const mainScript = document.getElementById('mainScript');
      if(mainScript){
        mainScript.addEventListener('load', ()=>{ hidePreloader('script-loaded'); });
        mainScript.addEventListener('error', ()=>{ /* allow fallback */ });
      }

      // Safety: if user has JS disabled, hide preloader after 1s and show notice (non-JS users)
      // This will only run if JS is enabled; we still provide a noscript section below for no-JS.
    })();
  </script>

  <!-- Main script (unchanged file) -->
  <script src="script.js" defer id="mainScript"></script>

  <noscript>
    <style>
      #preloader{display:none}
      main[aria-hidden="true"]{display:block}
    </style>
    <div style="position:fixed;left:0;right:0;bottom:0;background:#ffcc00;color:#071827;padding:8px;text-align:center;font-weight:800;z-index:9999">JavaScript is required for FNF Hub to work. Please enable JS or click Continue.</div>
  </noscript>

  <script>
    // minimal accessibility: if the page somehow remains covered, allow user to press "Escape" to dismiss preloader
    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape'){
        try{ window.hidePreloader && window.hidePreloader('escape-key'); }catch(e){}
      }
    });
  </script>
</body>
</html>
